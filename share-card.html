<!--
 * @Author: fghpdf
 * @Date: 2023-03-22 21:48:04
 * @LastEditTime: 2023-03-23 23:14:03
 * @LastEditors: fghpdf
-->
<!DOCTYPE html>
<html class="h-100">
  <head>
    <meta charset="UTF-8">
    <title>Image Preview Example</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
    <style>
      .bd-placeholder-img {
        font-size: 1.125rem;
        text-anchor: middle;
        -webkit-user-select: none;
        -moz-user-select: none;
        user-select: none;
      }

      @media (min-width: 768px) {
        .bd-placeholder-img-lg {
          font-size: 3.5rem;
        }
      }

      .b-example-divider {
        height: 3rem;
        background-color: rgba(0, 0, 0, .1);
        border: solid rgba(0, 0, 0, .15);
        border-width: 1px 0;
        box-shadow: inset 0 .5em 1.5em rgba(0, 0, 0, .1), inset 0 .125em .5em rgba(0, 0, 0, .15);
      }

      .b-example-vr {
        flex-shrink: 0;
        width: 1.5rem;
        height: 100vh;
      }

      .bi {
        vertical-align: -.125em;
        fill: currentColor;
      }

      .nav-scroller {
        position: relative;
        z-index: 2;
        height: 2.75rem;
        overflow-y: hidden;
      }

      .nav-scroller .nav {
        display: flex;
        flex-wrap: nowrap;
        padding-bottom: 1rem;
        margin-top: -1px;
        overflow-x: auto;
        text-align: center;
        white-space: nowrap;
        -webkit-overflow-scrolling: touch;
      }
    </style>
    <link href="./a.css" rel="stylesheet">
  </head>
  
  <body class="d-flex h-100 text-center text-bg-dark" data-new-gr-c-s-check-loaded="14.1027.0" data-gr-ext-installed="">
    <div class="cover-container d-flex w-100 h-100 p-3 mx-auto flex-column">
      <header class="mb-auto">
        <div>
          <h3 class="float-md-start mb-0">Share Card</h3>
          <nav class="nav nav-masthead justify-content-center float-md-end">
          </nav>
        </div>
      </header>
    
      <main class="px-3">
        <div class="d-flex justify-content-center mb-4">
          <img id="imagePreview" src="./credit-card-svgrepo-com.svg"
          alt="example placeholder" style="height: 380px; width: 600px;" />
        </div>
        <div class="">
          <div class="btn btn-outline-info btn-lg">
              <label class="text-white" for="chooseFileBtn">Choose file</label>
              <input type="file" class="form-control d-none" id="chooseFileBtn"/>
          </div>
          <button type="button" class="btn btn-outline-primary btn-lg" id="downloadBtn" disabled>Download</button>
        </div>
      </main>
    
      <footer class="mt-auto text-white-50">
        <p>Cover template for <a href="https://getbootstrap.com/" class="text-white">Bootstrap</a>, by <a href="https://twitter.com/mdo" class="text-white">@mdo</a>.</p>
      </footer>

      <!-- The overlay -->
      <div id="myNav" class="overlay">
        <!-- Overlay content -->
        <div class="overlay-content">
          <section class="fade-wrapper progress-section">
            <div class="container">
              <div class="row">
                <div class="col">
                  
                </div>
                <div class="col">
                  <div class="progress-bars-four" id="progressBar">
                    <h2 id="progressContent">40%</h2>
                  </div><!--progress-bars-->
                </div>
                <div class="col"></div>
              </div>
            </div>
            </section>
        </div>

      </div>
    </div>
    

    <script type="module">
      //import the library to talk to imagemagick
      import * as Magick from 'https://knicknic.github.io/wasm-imagemagick/magickApi.js';

      function showProgress() {
        document.getElementById("myNav").style.width = "100%";
      }

      function closeProgress() {
        document.getElementById("myNav").style.width = "0%";
      }

      function setProgress(progressNumber) {
        let progressDiv = document.getElementById('progressBar');
        let progressH2 = document.getElementById('progressContent');
        if (progressNumber <= 40) {
          progressDiv.setAttribute('class', "progress-bars-four");
          progressH2.innerHTML="40%";
          return;
        }

        if (progressNumber > 40 && progressNumber <= 65) {
          progressDiv.setAttribute('class', "progress-bars-six");
          progressH2.innerHTML="65%";
          return;
        }

        if (progressNumber > 65 && progressNumber <= 90) {
          progressDiv.setAttribute('class', "progress-bars-seven");
          progressH2.innerHTML="90%";
          return;
        }

        if (progressNumber > 90 && progressNumber <= 100) {
          progressDiv.setAttribute('class', "progress-bars");
          progressH2.innerHTML="98%";
          return;
        }
      }

      function handleImage(event) {
        const reader = new FileReader();
        reader.onload = function(){
          let img = document.getElementById('imagePreview');
          let sourceBytes = new Uint8Array(reader.result);

          const files = [{ 'name': 'srcFile.png', 'content': sourceBytes }];
          const command = ["convert", "srcFile.png", "\(", "+clone", "-background", 
          "black", "-shadow", "100x40+0+16", "\)", "+swap", "-background", "none", 
          "-layers", "merge", "+repage", "output.png"];
          showProgress();

          Magick.Call(files, command).then((processedFiles) => {
            
            setProgress(70);

            let firstOutputImage = processedFiles[0];
            
            return new Response(firstOutputImage['blob']).arrayBuffer();
          }).then((ab) => {
            setProgress(95);

            sourceBytes = new Uint8Array(ab);
            const aFiles = [{ 'name': 'output.png', 'content': sourceBytes }];
            const aCommand = ["convert", "output.png", "-bordercolor", "none", "-border", "32", "target.png"];

            return Magick.Call(aFiles, aCommand);
          }).then((processedFiles) => {

            let firstOutputImage = processedFiles[0];

            img.src = URL.createObjectURL(firstOutputImage['blob']);

            downloadBtn.removeAttribute('disabled');
            closeProgress();
          }).catch((err) => {
            console.error(err);
          })
        };
        
        reader.readAsArrayBuffer(event.target.files[0]);
      }

      function downloadFile(url, fileName) {
        fetch(url, { method: 'get', mode: 'no-cors', referrerPolicy: 'no-referrer' })
          .then(res => res.blob())
          .then(res => {
            const aElement = document.createElement('a');
            aElement.setAttribute('download', fileName);
            const href = URL.createObjectURL(res);
            aElement.href = href;
            aElement.setAttribute('target', '_blank');
            aElement.click();
            URL.revokeObjectURL(href);
          });
      };

      let squareBtn = document.getElementById("chooseFileBtn");
      let downloadBtn = document.getElementById("downloadBtn");

      /**
       * event
      **/
      squareBtn.addEventListener('change', (event) => {
        downloadBtn.setAttribute('disabled', '');
        handleImage(event);
      })

      
      downloadBtn.addEventListener('click', () => {
        var img = document.getElementById('imagePreview');

        downloadFile(img.src, "card.png");
      })
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js" integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN" crossorigin="anonymous"></script>
    
  </body>
</html>
